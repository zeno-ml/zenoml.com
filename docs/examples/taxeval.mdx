# TaxEval

[![Open with Zeno](https://img.shields.io/badge/%20-Open_with_Zeno-612593.svg?labelColor=white&logo=data:image/svg%2bxml;base64,PHN2ZyB3aWR0aD0iMzMiIGhlaWdodD0iMzMiIHZpZXdCb3g9IjAgMCAzMyAzMyIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTMyIDE1Ljc4NDJMMTYuNDg2MiAxNS43ODQyTDE2LjQ4NjIgMC4yNzA0MDFMMjQuMzAyIDguMDg2MTdMMzIgMTUuNzg0MloiIGZpbGw9IiM2MTI1OTMiLz4KPHBhdGggZD0iTTE1Ljc5MTcgMTUuODMxMUw4LjAzNDc5IDguMDc0MjJMMTUuNzkxNyAwLjMxNzMyOEwxNS43OTE3IDE1LjgzMTFaIiBmaWxsPSIjNjEyNTkzIiBmaWxsLW9wYWNpdHk9IjAuOCIvPgo8cGF0aCBkPSJNMTQuODY1NSAxNS44MzExTDcuNTk0ODUgMTUuODMxMUw3LjU5NDg1IDguNTYwNDJMMTQuODY1NSAxNS44MzExWiIgZmlsbD0iIzYxMjU5MyIgZmlsbC1vcGFjaXR5PSIwLjYiLz4KPHBhdGggZD0iTTYuMTEyOSAxNS44MzExTDMuMjQxNyAxNS44MzExTDMuMjQxNyAxMi44NjcyTDYuMTEyOSAxNS44MzExWiIgZmlsbD0iIzZBMUI5QSIgZmlsbC1vcGFjaXR5PSIwLjQiLz4KPHBhdGggZD0iTTIuNzMyMjggMTUuODMxTDEuNTE1NSAxNC42MTQzTDIuNzQyNzEgMTMuMzg3TDIuNzMyMjggMTUuODMxWiIgZmlsbD0iIzZBMUI5QSIgZmlsbC1vcGFjaXR5PSIwLjMiLz4KPHBhdGggZD0iTTIuMDM3NiAxNS43ODQyTDEuMTU3NzEgMTUuNzg0MkwxLjE1NzcxIDE0Ljk1MDZMMi4wMzc2IDE1Ljc4NDJaIiBmaWxsPSIjNkExQjlBIiBmaWxsLW9wYWNpdHk9IjAuMiIvPgo8cGF0aCBkPSJNMC44MzM1NjggMTUuNzg0MUwwLjUwOTM5OSAxNS40NkwwLjgzMzU2NyAxNS4xMzU4TDAuODMzNTY4IDE1Ljc4NDFaIiBmaWxsPSIjNjEyNTkzIiBmaWxsLW9wYWNpdHk9IjAuMSIvPgo8cGF0aCBkPSJNMC4xMDYxODcgMTUuNzk0NEwwLjMwMTAyNSAxNS41OTk2TDAuNDk1ODYzIDE1Ljc5NDRIMC4xMDYxODdaIiBmaWxsPSIjNjEyNTkzIiBmaWxsLW9wYWNpdHk9IjAuMSIvPgo8cGF0aCBkPSJNNi45NTIxMyAxNS44MjQ4TDMuNjQwOTkgMTIuNTEzN0w2Ljk2OTYzIDkuMTg1MDNMNi45NTIxMyAxNS44MjQ4WiIgZmlsbD0iIzYxMjU5MyIgZmlsbC1vcGFjaXR5PSIwLjUiLz4KPHBhdGggZD0iTTAuMjk0MjM1IDE2LjQ3OTVMMTUuODA4IDE2LjQ3OTVMMTUuODA4IDMxLjk5MzNMNy45OTIyMyAyNC4xNzc1TDAuMjk0MjM1IDE2LjQ3OTVaIiBmaWxsPSIjNjEyNTkzIi8+CjxwYXRoIGQ9Ik0xNi40OTU2IDE3LjI0MzZMMjMuODUwNyAyNC41ODVMMTYuNDk1NiAzMS45NEwxNi40OTU2IDE3LjI0MzZaIiBmaWxsPSIjNjEyNTkzIiBmaWxsLW9wYWNpdHk9IjAuOCIvPgo8cGF0aCBkPSJNMTYuNTMyNiAxNi40Nzk1TDI0LjQ1MTUgMTYuNDc5NUwyNC40NTE1IDI0LjAyOEwxNi41MzI2IDE2LjQ3OTVaIiBmaWxsPSIjNjEyNTkzIiBmaWxsLW9wYWNpdHk9IjAuNiIvPgo8cGF0aCBkPSJNMjYuMTgxMyAxNi40MzI2TDI5LjA1MjUgMTYuNDMyNkwyOS4wNTI1IDE5LjM5NjRMMjYuMTgxMyAxNi40MzI2WiIgZmlsbD0iIzZBMUI5QSIgZmlsbC1vcGFjaXR5PSIwLjQiLz4KPHBhdGggZD0iTTI5LjU2MTkgMTYuNDMyNkwzMC43Nzg3IDE3LjY0OTRMMjkuNTUxNSAxOC44NzY2TDI5LjU2MTkgMTYuNDMyNloiIGZpbGw9IiM2QTFCOUEiIGZpbGwtb3BhY2l0eT0iMC4zIi8+CjxwYXRoIGQ9Ik0zMC4yNTY2IDE2LjQ3OTVMMzEuMTM2NSAxNi40Nzk1TDMxLjEzNjUgMTcuMzEzMUwzMC4yNTY2IDE2LjQ3OTVaIiBmaWxsPSIjNkExQjlBIiBmaWxsLW9wYWNpdHk9IjAuMiIvPgo8cGF0aCBkPSJNMzEuNDYwNiAxNi40Nzk1TDMxLjc4NDggMTYuODAzN0wzMS40NjA2IDE3LjEyNzlMMzEuNDYwNiAxNi40Nzk1WiIgZmlsbD0iIzYxMjU5MyIgZmlsbC1vcGFjaXR5PSIwLjEiLz4KPHBhdGggZD0iTTMyLjE4OCAxNi40NjkyTDMxLjk5MzIgMTYuNjY0MUwzMS43OTgzIDE2LjQ2OTJIMzIuMTg4WiIgZmlsbD0iIzYxMjU5MyIgZmlsbC1vcGFjaXR5PSIwLjEiLz4KPHBhdGggZD0iTTI1LjM0MjEgMTYuNDM4OUwyOC42NTMyIDE5Ljc1TDI1LjMyNDYgMjMuMDc4NkwyNS4zNDIxIDE2LjQzODlaIiBmaWxsPSIjNjEyNTkzIiBmaWxsLW9wYWNpdHk9IjAuNSIvPgo8L3N2Zz4K)](https://hub.zenoml.com/project/e7519c8a-3c07-45ce-90f4-3a5ba4660ab6/LLM%20Taxes%20Benchmark)
[![Open Notebook](https://img.shields.io/badge/%20-Open_Notebook-F37726.svg?labelColor=white&logo=Jupyter)](https://github.com/zeno-ml/zeno-build/blob/main/taxeval/taxes.ipynb)

Ever wondered if an LLM can do your taxes?
In this example, we'll show you how to investigate the results of the [taxeval benchmark](https://github.com/danielgross/taxeval).
While we'll go through how to upload the results to Zeno in this example, please refer to the original repository if you want to run the benchmark on your own models.

## Dependencies

Let's start by installing the required dependencies for this project:

```bash
pip install pandas zeno-client python-dotenv bertopic
```

## Imports

After this is all set up, we can now start running our analysis code and uploading data to Zeno.
We'll first import relevant libraries which we're going to use:

```python
import pandas as pd
import json
import os
from dotenv import load_dotenv

from zeno_client import ZenoClient, ZenoMetric
```

### Loading the Data

We'll be uploading already processed model outputs.
You can get these [here](https://github.com/zeno-ml/zeno-build/blob/main/taxeval/tax-benchmark.json), alternatively, you can run your own models following [this README](https://github.com/danielgross/taxeval).

```python
data = json.load(open("tax-benchmark.json"))
```

### Formatting the Data

Before we can upload the data to Zeno, we'll need to convert it to a pandas DataFrame and will format some of the data so that we have all the information we're going to need in our Zeno project.

```python
def format_question(input):
    return_question = input["source_question"]["description"].replace("\\n", "\n")
    return_question += "\n\n"
    for answer in enumerate(input["source_question"]["options"]):
        return_question += f"{answer[0] + 1}. {answer[1]}\n"
    return return_question


df_input = pd.DataFrame(
    {
        "question": [format_question(d) for d in data],
        "answer": [str(d["source_question"]["correct_answer"]) for d in data],
        "reference": [d["source_question"]["reference"] for d in data],
        "tag": [d["source_question"]["tag"] for d in data],
        "category": [d["source_question"]["category"] for d in data],
    }
)
df_input["question length"] = df_input["question"].apply(lambda x: len(x))
df_input["id"] = df_input.index
```

<details>
  <summary>Optional: Generate Topics</summary>
  <div>
    If you want you can also add topic information to the data using bertopic as follows:
    ```python
    from bertopic import BERTopic

    topic_model = BERTopic("english", min_topic_size=3)
    topics, probs = topic_model.fit_transform(
    [d["source_question"]["description"] for d in data]
    )
    df_input["topic"] = topics
    df_input["topic"] = df_input["topic"].astype(str)
    ```

  </div>
</details>

### Create a Zeno Project

We can now upload our data to a Zeno project.
You will need your `ZENO_API_KEY` here, which you can generate by clicking on your profile at the top right to navigate to your [account page](https://hub.zenoml.com/account).

Once you have your API key, you can authenticate with the Zeno client and create a project as follows:

```python
client = zeno_client.ZenoClient(YOUR_API_KEY)

project = client.create_project(
    name="LLM Taxes Benchmark",
    view={
        "data": {"type": "markdown"},
        "label": {"type": "text"},
        "output": {"type": "markdown"},
    },
    description="Tax questions for LLMs",
    public=True,
    metrics=[
        ZenoMetric(name="accuracy", type="mean", columns=["correct"]),
        ZenoMetric(name="output length", type="mean", columns=["output length"]),
    ],
)
```

### Uploading Data

Now that all of this is set up, we can upload the data that we've formatted into a DataFrame before.

```python
project.upload_dataset(
    df_input, id_column="id", data_column="question", label_column="answer"
)
```

### Uploading System outputs

Finally, we're going to collect all the model outputs and upload each of the models' results as systems of our Zeno project.

```python
for model in data[0]["full"].keys():
    df_system = pd.DataFrame(
        {
            "output": [
                f"**Full:** {d['full'][model]}\n\n**Simplified**: {d['simplified'][model]}"
                for d in data
            ],
            "output length": [len(d["full"][model]) for d in data],
            "simplified output": [str(d["simplified"][model]) for d in data],
        }
    )
    df_system["correct"] = df_input["answer"] == df_system["simplified output"]
    df_system["id"] = df_input["id"]
    project.upload_system(
        df_system, name=model.replace("/", "-"), id_column="id", output_column="output"
    )
```
